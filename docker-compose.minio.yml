services:
  # MinIO 오브젝트 스토리지 서버(실제 파일 데이터 저장)
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    restart: unless-stopped
    container_name: mocktalk-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - mocktalk_minio_data:/data

  # MinIO 초기화 컨테이너(버킷 생성 등 1회성 준비 작업)
  # - minio 서비스가 준비될 때까지 대기
  # - 지정한 버킷이 없으면 생성, 이미 있으면 유지
  minio-init:
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    container_name: mocktalk-minio-init
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      until mc alias set local http://minio:9000 $${MINIO_ROOT_USER:-minioadmin} $${MINIO_ROOT_PASSWORD:-minioadmin}; do sleep 2; done &&
      mc mb --ignore-existing local/$${MINIO_BUCKET:-mocktalk}
      "
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-mocktalk}

volumes:
  # MinIO 데이터 영속 볼륨(컨테이너 재생성 후에도 파일 보존)
  mocktalk_minio_data:

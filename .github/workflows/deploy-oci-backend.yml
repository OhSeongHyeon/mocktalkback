name: Deploy OCI Backend

on:
  workflow_run:
    workflows:
      - Build Backend Image (GHCR)
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-oci-backend
  cancel-in-progress: true

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: SSH 키 로드
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.OCI_SSH_KEY }}

      - name: known_hosts 등록
        env:
          OCI_HOST: ${{ secrets.OCI_HOST }}
          OCI_SSH_PORT: ${{ secrets.OCI_SSH_PORT }}
        run: |
          set -euo pipefail
          SSH_PORT="${OCI_SSH_PORT:-22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "$SSH_PORT" -H "$OCI_HOST" >> ~/.ssh/known_hosts

      - name: OCI 배포 실행 (pull + no-build + health)
        env:
          OCI_HOST: ${{ secrets.OCI_HOST }}
          OCI_USER: ${{ secrets.OCI_USER }}
          OCI_SSH_PORT: ${{ secrets.OCI_SSH_PORT }}
          OCI_DEPLOY_PATH: ${{ secrets.OCI_DEPLOY_PATH }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          set -euo pipefail
          SSH_PORT="${OCI_SSH_PORT:-22}"
          DEPLOY_PATH="${OCI_DEPLOY_PATH:-~/mocktalkback}"

          ssh -p "$SSH_PORT" "${OCI_USER}@${OCI_HOST}" bash -s <<EOF
          set -euo pipefail
          cd "$DEPLOY_PATH"

          echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin
          docker compose -f docker-compose.oci-deploy.yml pull backend
          docker compose -f docker-compose.oci-deploy.yml up -d --no-build backend

          CODE=""
          for i in {1..30}; do
            CODE=\$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8082/api/health || true)
            if [ "\$CODE" = "200" ]; then
              break
            fi
            sleep 2
          done

          if [ "\$CODE" != "200" ]; then
            echo "health check failed: status=\$CODE"
            exit 1
          fi

          docker image prune -f
          EOF

      - name: 배포 완료 요약
        run: |
          echo "OCI 백엔드 배포 완료: ghcr.io/${{ github.repository_owner }}/mocktalkback:prod-latest" >> "$GITHUB_STEP_SUMMARY"
